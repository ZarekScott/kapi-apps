
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kapi â€” Create account</title>
  <link rel="stylesheet" href="assets/css/brand.css">
  <script src="assets/js/theme.js" defer></script>
  <style>
    .hero{display:grid;gap:10px;justify-items:center;text-align:center;margin:40px 0 10px}
    .hero .logo{font-weight:900;font-size:28px;letter-spacing:0.5px}
    .grid2{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width: 720px){ .grid2{grid-template-columns: 1fr 1fr} }
  </style>
</head>
<body>
  <header class="header">
    <div class="inner">
      <div class="logo"><strong>Kapi</strong></div>
      <nav class="nav"><a href="/apps.html">Apps</a></nav>
      <div class="actions">
        <button class="btn" onclick="toggleTheme()"><span id="themeLabel">ðŸŒ™</span></button>
      </div>
    </div>
  </header>

  <main class="kapi-container" style="padding:20px 0 40px">
    <section class="hero">
      <div class="badge">Create your account</div>
      <div class="logo">Join <span style="color:var(--accent)">Kapi</span></div>
      <div class="muted" id="heroSub">Weâ€™ll use a secure hosted page to sign you up.</div>
    </section>

    <div class="grid2">
      <div class="kapi-card p-6">
        <h2 class="m-0" style="margin-bottom:8px">Sign up with email</h2>
        <p class="muted">Youâ€™ll be redirected to Auth0 Universal Login.</p>
        <div class="field" style="max-width:480px">
          <label class="muted">Email address (optional)</label>
          <input class="input" id="email" type="email" placeholder="you@domain.com">
          <div id="emailHint" class="muted" style="display:none;margin-top:6px">Weâ€™ll prefill this on the hosted page.</div>
        </div>
        <div class="row" style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" id="openSignup">Create account</button>
          <a class="btn" href="#" id="openLogin">I already have an account</a>
        </div>
      </div>

      <div class="kapi-card p-6">
        <h3 class="m-0" style="margin-bottom:8px">What you get</h3>
        <ul class="muted" style="margin:0;padding-left:18px;line-height:1.6">
          <li>Access to your purchased apps in one place</li>
          <li>Hosted, secure signup & login via Auth0</li>
          <li>Easy upgrades and new tools as we launch them</li>
        </ul>
        <div class="row" style="margin-top:12px">
          <a class="btn" href="/apps.html">Explore Apps</a>
        </div>
      </div>
    </div>
  </main>

  <!-- Auth0 -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.5/auth0-spa-js.production.js"></script>
  <script src="/auth0-config.js"></script>
  <script src="/auth0-client.js"></script>

  <script>
  async function waitAuth() {
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    for (let i=0;i<200;i++){
      if (window.kapiAuth?.isAuthenticated) return true;
      await sleep(20);
    }
    return false;
  }
  (async ()=>{
    const ok = await waitAuth();
    const emailEl = document.getElementById('email');
    const emailHint = document.getElementById('emailHint');
    const heroSub = document.getElementById('heroSub');
    if (!ok) { alert('Sign up temporarily unavailable. Refresh and try again.'); return; }

    try {
      const loggedIn = await kapiAuth.isAuthenticated();
      if (loggedIn) {
        const u = await kapiAuth.getUser();
        heroSub.textContent = u?.email ? `You're signed in as ${u.email}.` : `You're signed in.`;
      }
    } catch(e){}

    function showErr(where, err){
      const msg = (err && (err.error_description || err.message || err.error)) || String(err);
      alert(`${where} failed: ${msg}`);
    }

    document.getElementById('openSignup').addEventListener('click', async (e)=>{
      e.preventDefault();
      const email = (emailEl.value || '').trim();
      if (email) emailHint.style.display='block';
      try { await kapiAuth.signup({ authorizationParams: { login_hint: email || undefined } }); }
      catch (err) { showErr('Signup', err); }
    });
    document.getElementById('openLogin').addEventListener('click', async (e)=>{
      e.preventDefault();
      const email = (emailEl.value || '').trim();
      try { await kapiAuth.login({ authorizationParams: { login_hint: email || undefined } }); }
      catch (err) { showErr('Login', err); }
    });
  })();
  </script>
</body>
</html>
