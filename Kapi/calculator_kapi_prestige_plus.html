<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kapi ‚Äî Deal Calculator ¬∑ Prestige+</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    /* ===== Prestige+ theme (dark default) ===== */
    :root{
      --bg:#0a0f17;
      --panel:#0e1523;
      --panel-2:#0b1220;
      --ink:#e8eef6;
      --muted:#9ca9bd;
      --border:#1a2538;
      --accent:#10b981; /* default emerald */
      --accent-weak: rgba(16,185,129,.16);
      --good:#10b981;
      --bad:#ef4444;
      --warning:#f59e0b;
      --shadow: 0 0 0px var(--accent), 0 0 8px var(--accent), 0 0 18px var(--accent);
      --radius:16px;
      --tip-bg: rgba(7,12,20,.96);
      --tip-border: #19304f;
      --btn-ink:#04130e; /* flips to white for graphite-smart on light/mid in JS */
    }
    /* Light theme */
    [data-theme="light"]{
      --bg:#f6f8fb; --panel:#ffffff; --panel-2:#f3f5f8; --ink:#0f172a; --muted:#51607a; --border:#e5ebf2;
      --tip-bg:#ffffff; --tip-border:#dbe3ec;
      --shadow: 0 0 0px var(--accent), 0 0 10px var(--accent), 0 0 22px var(--accent);
    }
    /* Mid (grey) theme */
    [data-theme="mid"]{
      --bg:#121823;
      --panel:#182030;
      --panel-2:#141c2b;
      --ink:#e3e8f2;
      --muted:#9aa6bb;
      --border:#243149;
      --tip-bg:#1a2333;
      --tip-border:#2a3a55;
      --shadow: 0 0 0px var(--accent), 0 0 9px var(--accent), 0 0 20px var(--accent);
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:12px}

    /* Badge logo with a K + smiley */
    .k{
      width:44px;height:44px;border-radius:14px;
      background:
        radial-gradient(40% 40% at 70% 30%, var(--accent-weak), transparent 60%),
        linear-gradient(140deg, transparent 40%, var(--accent-weak));
      border:1px solid var(--accent);box-shadow:var(--shadow);
      position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;
    }
    .k::before{
      content:"";position:absolute;inset:9px 12px;border:3px solid var(--accent);
      border-left:0;border-top:0;border-bottom-right-radius:10px;filter:drop-shadow(0 0 6px var(--accent));
    }
    .k-mark{position:relative; z-index:1; display:flex; align-items:center; gap:4px;}
    .k-letter{
      font-weight:900; font-size:22px; line-height:1;
      color:var(--accent); text-shadow:0 0 6px var(--accent-weak), 0 0 10px var(--accent-weak); letter-spacing:.5px
    }
    .k-smile{ font-size:18px; line-height:1; transform: translateY(1px); }
    /* Make the K white on the Mid theme */
    [data-theme="mid"] .k-letter{
      color:#ffffff;
      text-shadow:0 0 6px rgba(255,255,255,.3), 0 0 10px rgba(255,255,255,.45);
    }

    .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn,.chip{border:1px solid var(--border);border-radius:12px;background:transparent;color:var(--ink);padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--accent);color:var(--btn-ink);border-color:transparent;box-shadow:var(--shadow)}
    a{color:var(--accent)}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--border);border-radius:var(--radius);padding:16px}
    h2{margin:0 0 10px 0}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--border);margin:10px 0}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .field{display:flex;flex-direction:column;gap:6px;grid-column: span 6; position:relative}
    .field.sm{grid-column: span 3}
    .field.md{grid-column: span 4}
    .field.lg{grid-column: span 8}
    .field.full{grid-column: 1/-1}
    label{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px}
    input, select{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:inherit}
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}

    /* Dark & Mid theme: make selects slightly lighter to stand out */
    body:not([data-theme="light"]) select { color:#c7cfdd; }
    body:not([data-theme="light"]) option { color:#c7cfdd; background:#0e1523; }

    .lamp{display:flex;align-items:center;gap:10px}
    .dot{width:14px;height:14px;border-radius:999px;border:2px solid var(--border)}
    .dot.good{background:var(--good);box-shadow:0 0 10px var(--good), 0 0 18px var(--good)}
    .dot.bad{background:var(--bad);box-shadow:0 0 10px var(--bad), 0 0 18px var(--bad)}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:12px}
    @media (max-width:1000px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{background:var(--panel-2);border:1px solid var(--border);border-radius:14px;padding:12px}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:22px;font-weight:900}

    .badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:4px 8px;background:var(--panel-2);font-size:12px}
    .legend{display:flex;gap:8px;flex-wrap:wrap}

    /* Accent swatches in a grid */
    #accentList{display:grid !important; grid-template-columns: repeat(5, 28px); gap:8px; align-items:center}
    #accentList .sw{width:28px; height:28px; border-radius:8px; border:1px solid var(--border); background: var(--sw, transparent); cursor:pointer}

    /* Tables */
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{font-size:12px; color:var(--muted); text-align:right; padding:6px 8px; border-bottom:1px solid var(--border)}
    thead th:first-child, tbody td:first-child{text-align:left}
    tbody td{padding:8px; border-bottom:1px solid var(--border); text-align:right; font-variant-numeric: tabular-nums}
    tbody tr:last-child td{border-bottom:0}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:var(--panel-2); font-size:12px}
    .mini{font-size:12px; color:var(--muted)}

    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px dashed var(--border);border-radius:999px;background:rgba(16,185,129,.12)}
    .flag{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:10px;padding:6px 10px}

    /* Help tooltips */
    .help{ position:absolute;left:0;bottom:100%;transform:translateY(8px);
      max-width:min(420px, 90vw); background:var(--tip-bg);color:var(--ink);
      border:1px solid var(--tip-border);border-radius:10px; padding:8px 10px;
      box-shadow:0 6px 24px rgba(0,0,0,.35); font-size:12px;line-height:1.35;
      opacity:0;pointer-events:none;transition:opacity .15s ease, transform .15s ease; z-index:5; display:block }
    .help::after{content:""; position:absolute; left:12px; top:100%; border:6px solid transparent; border-top-color:var(--tip-bg); filter:drop-shadow(0 -1px 0 var(--tip-border));}
    body[data-help="1"] .field:hover .help, body[data-help="1"] .field:focus-within .help{opacity:1; transform:translateY(0); pointer-events:auto}
    body[data-help="0"] .help{display:none}

    /* Runner emojis */
    .ninja{position:fixed; bottom:1%; left:-80px; font-size:28px; filter:drop-shadow(0 0 6px rgba(0,0,0,.5)); pointer-events:none; z-index:9999}
    .pirate{position:fixed; bottom:calc(1% + 44px); left:-80px; font-size:30px; filter:drop-shadow(0 0 6px rgba(0,0,0,.5)); pointer-events:none; z-index:10000}
    @keyframes runAcross{ from{ transform:translateX(0) } to{ transform:translateX(calc(100vw + 160px)) } }
    .ninja.run,.pirate.run{ animation: runAcross 4s linear forwards }
    @media (prefers-reduced-motion: reduce){ .ninja.run,.pirate.run{ animation-duration: 0.001s } }

    /* Reset modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:11000 }
    .modal{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; width:min(520px, 92vw); box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .modal h3{margin:0 0 8px 0}
    .modal p{margin:0 0 12px 0; color:var(--muted)}
    .modal .actions{display:flex; gap:10px; justify-content:flex-end}
    .modal .actions .btn{font-weight:800}
    .show{display:flex !important}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <!-- K + smiley brand mark -->
        <div class="k" aria-hidden="true">
          <span class="k-mark"><span class="k-letter">K</span><span class="k-smile">üôÇ</span></span>
        </div>
      </div>
      <div class="controls">
        <a class="chip" href="index.html" title="Home">üè† Home</a>

        <span class="badge">Theme</span>
        <button class="chip" id="themeToggle" aria-label="Toggle theme">üåô</button>

        <span class="badge">Accent</span>
        <div class="legend" id="accentList">
          <button class="sw" data-key="emerald"  style="--sw:#10b981" title="Emerald"></button>
          <button class="sw" data-key="lime"     style="--sw:#3f6212" title="Lime (Green)"></button>
          <button class="sw" data-key="cyan"     style="--sw:#22d3ee" title="Cyan"></button>
          <button class="sw" data-key="fuchsia"  style="--sw:#e879f9" title="Fuchsia"></button>
          <button class="sw" data-key="purple"   style="--sw:#a78bfa" title="Purple"></button>
          <button class="sw" data-key="amber"    style="--sw:#f59e0b" title="Amber"></button>
          <button class="sw" data-key="azure"    style="--sw:#2563eb" title="Azure"></button>
          <button class="sw" data-key="rose"     style="--sw:#db2777" title="Rose"></button>
          <button class="sw" data-key="magenta"  style="--sw:#a21caf" title="Magenta (deep)"></button>
          <button class="sw" data-key="graphite-smart" title="Smart Black/White"></button>
        </div>

        <label class="badge"><input type="checkbox" id="helpMode" style="accent-color:var(--accent)"> Help mode</label>
        <button class="chip" id="ninjaBtn" title="Let the ninja run">ü•∑ Ninja</button>
        <button class="chip" id="pirateBtn" title="Let the pirate run">‚ò†Ô∏è Pirate</button>
      </div>
    </header>

    <section class="kpis" id="kpis">
      <div class="kpi"><div class="label">NOI (annual)</div><div class="value" id="kpiNOI">‚Äî</div></div>
      <div class="kpi"><div class="label">Cash Flow (annual)</div><div class="value" id="kpiCF">‚Äî</div></div>
      <div class="kpi"><div class="label">DSCR</div><div class="value" id="kpiDSCR">‚Äî</div></div>
      <div class="kpi"><div class="label">Cap Rate</div><div class="value" id="kpiCap">‚Äî</div></div>
      <div class="kpi"><div class="label">Cash-on-Cash</div><div class="value" id="kpiCoC">‚Äî</div></div>
    </section>

    <div class="grid">
      <!-- LEFT: Inputs -->
      <section class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <h2>Deal Basics</h2>
          <div class="lamp"><span id="signalDot" class="dot"></span><span id="signalText" class="muted">‚Äî</span></div>
        </div>

        <div class="row">
          <div class="field md">
            <label>Property type <span class="pill">MF ¬∑ SFH ¬∑ Retail ¬∑ Office ¬∑ Industrial</span></label>
            <select id="propType">
              <option>Multifamily</option><option>Single-family</option><option>Retail</option><option>Office</option><option>Industrial</option>
            </select>
            <div class="help">Sets typical defaults for vacancy & expenses.</div>
          </div>
          <div class="field md">
            <label>Lease type <span class="pill">NNN ¬∑ MG ¬∑ Gross</span></label>
            <select id="leaseType"><option>NNN</option><option>Modified Gross</option><option>Gross</option></select>
            <div class="help">NNN: tenant pays most opex; MG/Gross: landlord pays some/all.</div>
          </div>
          <div class="field md">
            <label>Units</label>
            <input id="units" type="number" min="0" step="1" value="6">
            <div class="help">Used for price/door metric (if &gt; 0).</div>
          </div>
          <div class="field md">
            <label>Square footage (SF)</label>
            <input id="sqft" type="number" min="0" step="50" value="5200">
            <div class="help">Used for price/SF metric (if &gt; 0).</div>
          </div>

          <div class="field md">
            <label>Purchase price ($)</label>
            <input id="price" type="number" min="0" step="1000" value="525000">
            <div class="help">Contract price (before closing & renovations).</div>
          </div>
          <div class="field md">
            <label>Down payment (%)</label>
            <input id="downPct" type="number" min="0" max="100" step="0.5" value="25">
            <div class="help">Percent of price paid upfront.</div>
          </div>
          <div class="field md">
            <label>Closing costs (%)</label>
            <input id="closePct" type="number" min="0" step="0.1" value="3">
            <div class="help">Typical 2‚Äì4% of price.</div>
          </div>
          <div class="field md">
            <label>Upfront CapEx / Renovation ($)</label>
            <input id="reno" type="number" min="0" step="500" value="15000">
            <div class="help">One-time improvements at/after closing.</div>
          </div>
        </div>

        <div class="hr"></div>
        <h2>Income</h2>
        <div class="row">
          <div class="field md">
            <label>Monthly rent ($)</label>
            <input id="rent" type="number" min="0" step="50" value="6200">
            <div class="help">Total scheduled rent per month (all units/tenants).</div>
          </div>
          <div class="field md">
            <label>Other income / month ($)</label>
            <input id="otherInc" type="number" min="0" step="10" value="250">
            <div class="help">Parking, laundry, reimbursements, etc.</div>
          </div>
          <div class="field md">
            <label>Vacancy (%)</label>
            <input id="vacancy" type="number" min="0" max="100" step="0.5" value="6">
            <div class="help">Economic vacancy allowance.</div>
          </div>
          <div class="field md">
            <label>GRM (info)</label>
            <input id="grmDisplay" disabled value="‚Äî">
            <div class="help">Gross Rent Multiplier = Price / (Gross Rent Annual).</div>
          </div>
        </div>

        <div class="hr"></div>
        <h2>Expenses</h2>
        <div class="row">
          <div class="field md">
            <label>Expense mode</label>
            <select id="expMode"><option>Ratio (%)</option><option>Advanced (itemized)</option></select>
            <div class="help">Use a simple ratio or itemize below.</div>
          </div>
          <div class="field md" id="expRatioBox">
            <label>Expense ratio (%)</label>
            <input id="expRatio" type="number" min="0" max="100" step="1" value="35">
            <div class="help">MF 35‚Äì50%, SFH 20‚Äì30%, Retail 15‚Äì25% (starting points).</div>
          </div>
        </div>
        <div id="advWrap" style="display:none">
          <div class="row" style="margin-top:8px">
            <div class="field md"><label>Taxes / mo ($)</label><input id="taxes" type="number" min="0" step="10" value="420"><div class="help">Annualized in results.</div></div>
            <div class="field md"><label>Insurance / mo ($)</label><input id="ins" type="number" min="0" step="10" value="190"><div class="help">Annualized in results.</div></div>
            <div class="field md"><label>Utilities / mo ($)</label><input id="utils" type="number" min="0" step="10" value="120"><div class="help">Only landlord-paid utilities.</div></div>
            <div class="field md"><label>Repairs/CapEx reserve / mo ($)</label><input id="repairs" type="number" min="0" step="10" value="250"><div class="help">Ongoing reserve; not upfront CapEx.</div></div>
            <div class="field md"><label>Mgmt fee (% of EGI)</label><input id="mgmtPct" type="number" min="0" step="0.5" value="7"><div class="help">Typical 5‚Äì10%.</div></div>
            <div class="field md"><label>HOA/Other / mo ($)</label><input id="hoa" type="number" min="0" step="10" value="0"><div class="help">HOA, landscaping, security, etc.</div></div>
          </div>
        </div>

        <div class="hr"></div>
        <h2>Financing</h2>
        <div class="row">
          <div class="field md">
            <label>Loan type</label>
            <select id="loanType"><option>Amortizing</option><option>Interest Only</option></select>
            <div class="help">I/O = lower payment, no principal reduction.</div>
          </div>
          <div class="field md"><label>Interest rate (% APR)</label><input id="rate" type="number" min="0" step="0.05" value="6.75"><div class="help">APR.</div></div>
          <div class="field md"><label>Term (years)</label><input id="termYears" type="number" min="0" step="1" value="30"><div class="help">Amortization period.</div></div>
          <div class="field md"><label>I/O period (months)</label><input id="ioMonths" type="number" min="0" step="1" value="0"><div class="help">Months of interest-only.</div></div>
        </div>

        <div class="hr"></div>
        <h2>Projection Assumptions</h2>
        <div class="row">
          <div class="field md"><label>Rent growth / yr (%)</label><input id="gRent" type="number" min="0" step="0.25" value="3"></div>
          <div class="field md"><label>Other income growth / yr (%)</label><input id="gOther" type="number" min="0" step="0.25" value="2"></div>
          <div class="field md"><label>Opex growth / yr (%)</label><input id="gOpex" type="number" min="0" step="0.25" value="2.5"></div>
          <div class="field md"><label>Exit cap rate (%)</label><input id="exitCap" type="number" min="0" step="0.1" value="7.0"></div>
        </div>

        <div class="hr"></div>
        <h2>Investor Targets</h2>
        <div class="row">
          <div class="field md"><label>Min DSCR</label><input id="targetDSCR" type="number" min="0" step="0.05" value="1.20"><div class="help">Common lender floor ‚â• 1.20.</div></div>
          <div class="field md"><label>Min Cash-on-Cash (%)</label><input id="targetCoC" type="number" min="0" step="0.5" value="8"><div class="help">Investor minimum return target.</div></div>
          <div class="field md"><label>Max LTV (%)</label><input id="targetLTV" type="number" min="0" step="1" value="80"><div class="help">Loan-to-value limit.</div></div>
          <div class="field md"><label>&nbsp;</label><div class="flag"><span id="flagDSCR" class="muted">DSCR ‚Äî</span></div></div>
        </div>

        <div class="hr"></div>
        <div class="row">
          <div class="field md"><label>Sample</label><button class="btn" id="btnSample">Load example</button></div>
          <div class="field md"><label>Persistence</label><button class="btn" id="btnSave">Save inputs</button></div>
          <div class="field md"><label>&nbsp;</label><button class="btn" id="btnReset">Reset</button></div>
          <div class="field md"><label>&nbsp;</label><button class="btn primary" id="btnExport">Export CSV</button></div>
        </div>
      </section>

      <!-- RIGHT: Results + Value-Add + Projection -->
      <section class="panel">
        <h2>Results (Year-1)</h2>
        <div class="hr"></div>
        <div class="row">
          <div class="field md"><label>Upfront cash invested</label><input id="upfront" disabled></div>
          <div class="field md"><label>Loan amount</label><input id="loanAmt" disabled></div>
          <div class="field md"><label>Monthly debt service</label><input id="moDebt" disabled></div>
          <div class="field md"><label>Annual debt service</label><input id="annDebt" disabled></div>
          <div class="field md"><label>Effective Gross Income (EGI)</label><input id="egi" disabled></div>
          <div class="field md"><label>Operating expenses</label><input id="opex" disabled></div>
          <div class="field md"><label>NOI</label><input id="noi" disabled></div>
          <div class="field md"><label>Cash flow</label><input id="annCF" disabled></div>
          <div class="field md"><label>DSCR</label><input id="dscr" disabled></div>
          <div class="field md"><label>Cap rate</label><input id="cap" disabled></div>
          <div class="field md"><label>Cash-on-Cash</label><input id="coc" disabled></div>
          <div class="field md"><label>Break-even occupancy</label><input id="beOcc" disabled></div>
          <div class="field md"><label>LTV (Loan / Price)</label><input id="ltv" disabled></div>
          <div class="field md"><label>LTC (Loan /(Price+CapEx+Closing))</label><input id="ltc" disabled></div>
          <div class="field md"><label>Price / Unit</label><input id="ppu" disabled></div>
          <div class="field md"><label>Price / SF</label><input id="ppsf" disabled></div>
        </div>

        <!-- Value-Add Simulator -->
        <div class="hr"></div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <h2>Value-Add Simulator</h2>
          <span class="tag">What if we upgrade?</span>
        </div>
        <div class="hr"></div>
        <div class="row">
          <div class="field md">
            <label>Years out (1‚Äì10)</label>
            <input id="vaYears" type="number" min="1" max="10" step="1" value="3">
            <div class="help">Horizon to measure NOI lift & value.</div>
          </div>
          <div class="field md">
            <label>Units affected</label>
            <input id="vaUnits" type="number" min="0" step="1" value="6">
            <div class="help">How many units get the upgrades.</div>
          </div>
          <div class="field md">
            <label>Rent uplift / unit / mo ($)</label>
            <input id="vaRentUplift" type="number" min="0" step="10" value="75">
            <div class="help">Renovations, finishes, etc.</div>
          </div>
          <div class="field md">
            <label>Amenities & other / unit / mo ($)</label>
            <input id="vaOtherUplift" type="number" min="0" step="5" value="25">
            <div class="help">Appliances, valet trash, parking.</div>
          </div>
          <div class="field md">
            <label>Extra opex / mo (total) ($)</label>
            <input id="vaOpexDelta" type="number" min="0" step="10" value="0">
            <div class="help">New servicing costs, utilities, etc.</div>
          </div>
          <div class="field md">
            <label>CapEx (one-time) ($)</label>
            <input id="vaCapex" type="number" min="0" step="500" value="30000">
            <div class="help">Renovation budget to enable uplift.</div>
          </div>
          <div class="field md">
            <label>Cap rate for value (%)</label>
            <input id="vaCap" type="number" min="1" step="0.1" value="7.0">
            <div class="help">Used to convert NOI lift to value.</div>
          </div>
          <div class="field md">
            <label><input id="vaGrow" type="checkbox" checked style="accent-color:var(--accent)"> Grow uplift w/ rent growth</label>
            <div class="help">If checked, uplift compounds at rent growth.</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="row">
          <div class="field md"><label>Added NOI (Yr-1 of uplift)</label><input id="vaNOI1" disabled></div>
          <div class="field md"><label>Added NOI (Target Year)</label><input id="vaNOIN" disabled></div>
          <div class="field md"><label>Implied Value Added</label><input id="vaValue" disabled></div>
          <div class="field md"><label>Payback (yrs est.)</label><input id="vaPayback" disabled></div>
        </div>

        <!-- 10-Year Projection -->
        <div class="hr"></div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <h2>10-Year Projection</h2>
          <span class="mini">Assumes constant vacancy & loan rate; I/O transitions are handled per year.</span>
        </div>
        <div class="hr"></div>
        <div class="field full">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Year</th>
                  <th>EGI</th>
                  <th>Opex</th>
                  <th>NOI</th>
                  <th>Debt</th>
                  <th>CF</th>
                  <th>DSCR</th>
                  <th>Value @ Exit Cap</th>
                </tr>
              </thead>
              <tbody id="projBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Reset confirmation modal -->
  <div class="modal-backdrop" id="resetModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="resetTitle">
      <h3 id="resetTitle">Reset all inputs?</h3>
      <p>This will <strong>clear every numeric field</strong> and remove your saved inputs. This cannot be undone.</p>
      <div class="actions">
        <button class="btn" id="cancelReset">Cancel</button>
        <button class="btn primary" id="confirmReset">Yes, reset</button>
      </div>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const money0 = n => '$'+(n||0).toLocaleString(undefined,{maximumFractionDigits:0});
    const money = n => (n<0?'-':'')+'$'+Math.abs(n||0).toLocaleString(undefined,{maximumFractionDigits:0});

    /* ===== Theme & Accent (3-state) ===== */
    const themeToggle = $('themeToggle');
    const THEMES = ['dark','mid','light'];
    const ACCENTS = {
      emerald: { dark:'#10b981', mid:'#10b981', light:'#10b981' },
      lime:    { dark:'#3f6212', mid:'#3f6212', light:'#3f6212' },
      cyan:    { dark:'#22d3ee', mid:'#22d3ee', light:'#22d3ee' },
      fuchsia: { dark:'#e879f9', mid:'#e879f9', light:'#e879f9' },
      purple:  { dark:'#a78bfa', mid:'#a78bfa', light:'#a78bfa' },
      amber:   { dark:'#f59e0b', mid:'#f59e0b', light:'#f59e0b' },
      azure:   { dark:'#2563eb', mid:'#2563eb', light:'#2563eb' },
      rose:    { dark:'#db2777', mid:'#db2777', light:'#db2777' },
      magenta: { dark:'#a21caf', mid:'#a21caf', light:'#a21caf' },
      /* Smart: white on dark, BLACK on Mid, near-black on Light */
      'graphite-smart': { dark:'#ffffff', mid:'#000000', light:'#111827' }
    };
    function currentTheme(){ return document.body.getAttribute('data-theme') || 'dark'; }
    function setTheme(next){
      if (next==='dark') document.body.removeAttribute('data-theme');
      else document.body.setAttribute('data-theme', next);
      localStorage.setItem('kapi.theme', next);
      themeToggle.textContent = next==='light' ? 'üåû' : (next==='mid' ? 'üåÖ' : 'üåô');
      reapplyAccent(); paintSwatches();
    }
    function cycleTheme(){
      const idx = THEMES.indexOf(currentTheme());
      setTheme(THEMES[(idx+1)%THEMES.length]);
    }
    function migrateAccentKey(key){ return key==='white' ? 'graphite-smart' : (ACCENTS[key]?key:'emerald'); }
    function setAccentForTheme(keyRaw){
      const key = migrateAccentKey(keyRaw);
      const theme = currentTheme();
      const hex = (ACCENTS[key] && ACCENTS[key][theme]) || ACCENTS['emerald'][theme];
      document.documentElement.style.setProperty('--accent', hex);
      document.documentElement.style.setProperty('--accent-weak', hex + '28');
      const whiteInk = (key === 'graphite-smart' && (theme==='light' || theme==='mid')) ? '#ffffff' : '#04130e';
      document.documentElement.style.setProperty('--btn-ink', whiteInk);
      localStorage.setItem('kapi.accentKey', key);
    }
    function reapplyAccent(){ setAccentForTheme(localStorage.getItem('kapi.accentKey') || 'emerald'); }

    /* Make swatches visible in every theme, esp. graphite-smart on Mid */
    function paintSwatches(){
      const theme = currentTheme();
      document.querySelectorAll('#accentList .sw').forEach(btn => {
        const key = btn.dataset.key;
        const map = ACCENTS[key];
        btn.style.boxShadow = ''; /* reset any previous outline */
        if (key === 'graphite-smart'){
          const col = theme==='dark' ? '#ffffff' : '#000000';
          btn.style.background = col;
          /* Outline for visibility on dark surfaces when black */
          if (col === '#000000'){
            btn.style.boxShadow = 'inset 0 0 0 2px rgba(255,255,255,.25)';
          }
        } else if (map) {
          btn.style.background = map[theme];
        } else {
          const css = getComputedStyle(btn).getPropertyValue('--sw');
          if (css) btn.style.background = css.toString().trim();
        }
      });
    }

    function loadTheme(){
      const t = localStorage.getItem('kapi.theme')||'dark';
      setTheme(t);
      reapplyAccent(); paintSwatches();
    }
    themeToggle.addEventListener('click', cycleTheme);
    document.querySelectorAll('#accentList .sw').forEach(btn => btn.addEventListener('click', () => setAccentForTheme(btn.dataset.key)));

    /* ===== Help mode ===== */
    const helpToggle = $('helpMode');
    function setHelp(on){ document.body.setAttribute('data-help', on ? '1' : '0'); localStorage.setItem('kapi.help', on?'1':'0'); }
    const savedHelp = localStorage.getItem('kapi.help')==='1'; setHelp(savedHelp); helpToggle.checked = savedHelp;
    helpToggle.addEventListener('change', e=>setHelp(!!e.target.checked));

    /* ===== Expense mode ===== */
    const expMode = $('expMode'), advWrap = $('advWrap'), expRatioBox = $('expRatioBox');
    function updateExpMode(){ const adv = expMode.value.includes('Advanced'); advWrap.style.display = adv?'block':'none'; expRatioBox.style.display = adv?'none':'block'; }
    expMode.addEventListener('change', updateExpMode); updateExpMode();

    /* ===== Persistence ===== */
    const inputs = ['propType','leaseType','units','sqft','price','downPct','closePct','reno','rent','otherInc','vacancy','expMode','expRatio','taxes','ins','utils','repairs','mgmtPct','hoa','loanType','rate','termYears','ioMonths','targetDSCR','targetCoC','targetLTV','gRent','gOther','gOpex','exitCap','vaYears','vaUnits','vaRentUplift','vaOtherUplift','vaOpexDelta','vaCapex','vaCap'];
    function saveInputs(){ const data = {}; inputs.forEach(id=>data[id] = $(id).value); localStorage.setItem('kapi.prestige.inputs', JSON.stringify(data)); }
    function loadInputs(){ try{ const data = JSON.parse(localStorage.getItem('kapi.prestige.inputs')||'{}'); inputs.forEach(id=>{ if (data[id]!==undefined) $(id).value = data[id]; }); updateExpMode(); }catch{} }
    $('btnSave').addEventListener('click', ()=>{ saveInputs(); alert('Saved ‚úì'); });

    /* ===== Sample ===== */
    $('btnSample').addEventListener('click', ()=>{
      $('propType').value='Multifamily';
      $('leaseType').value='Modified Gross';
      $('units').value=6; $('sqft').value=5200;
      $('price').value=525000; $('downPct').value=25; $('closePct').value=3; $('reno').value=15000;
      $('rent').value=6200; $('otherInc').value=250; $('vacancy').value=6;
      $('expMode').value='Advanced (itemized)'; updateExpMode();
      $('taxes').value=420; $('ins').value=190; $('utils').value=120; $('repairs').value=250; $('mgmtPct').value=7; $('hoa').value=0;
      $('loanType').value='Amortizing'; $('rate').value=6.75; $('termYears').value=30; $('ioMonths').value=0;
      $('gRent').value=3; $('gOther').value=2; $('gOpex').value=2.5; $('exitCap').value=7.0;
      $('targetDSCR').value=1.20; $('targetCoC').value=8; $('targetLTV').value=80;
      $('vaYears').value=3; $('vaUnits').value=6; $('vaRentUplift').value=75; $('vaOtherUplift').value=25; $('vaOpexDelta').value=0; $('vaCapex').value=30000; $('vaCap').value=7.0;
      analyze();
    });

    /* ===== Reset (clears fields) ===== */
    const resetModal = $('resetModal');
    const confirmResetBtn = $('confirmReset');
    const cancelResetBtn = $('cancelReset');
    function anyDataEntered(){
      const saved = !!localStorage.getItem('kapi.prestige.inputs');
      let anyFilled = false;
      document.querySelectorAll('input[type="number"]').forEach(el=>{
        const raw = (el.value ?? '').toString().trim();
        if (raw !== '') anyFilled = true;
      });
      return saved || anyFilled;
    }
    function openResetModal(){ resetModal.classList.add('show'); }
    function closeResetModal(){ resetModal.classList.remove('show'); }
    function clearInputs(){
      document.querySelectorAll('input[type="number"]').forEach(el=>{ el.value = ''; });
      localStorage.removeItem('kapi.prestige.inputs');
      updateExpMode(); analyze();
    }
    $('btnReset').addEventListener('click', ()=>{ anyDataEntered() ? openResetModal() : clearInputs(); });
    cancelResetBtn.addEventListener('click', closeResetModal);
    confirmResetBtn.addEventListener('click', ()=>{ closeResetModal(); clearInputs(); });

    /* ===== Finance helpers ===== */
    function amortPayment(P, annualRate, years){
      const r = (annualRate/100)/12, n = Math.max(0, years*12|0);
      if (n===0) return 0;
      if (r===0) return P/n;
      return P * (r*Math.pow(1+r,n)) / (Math.pow(1+r,n)-1);
    }

    /* ===== Analyzer ===== */
    function analyze(){
      const toNum = v => +v || 0;

      const price = toNum($('price').value);
      const downPct = toNum($('downPct').value)/100;
      const closePct = toNum($('closePct').value)/100;
      const reno = toNum($('reno').value);
      const units = toNum($('units').value);
      const sqft = toNum($('sqft').value);

      const loanType = $('loanType').value;
      const rate = toNum($('rate').value);
      const years = toNum($('termYears').value);
      const ioMonths = Math.max(0, toNum($('ioMonths').value)|0);

      const rent = toNum($('rent').value);
      const otherInc = toNum($('otherInc').value);
      const vacancy = toNum($('vacancy').value)/100;

      const expModeVal = $('expMode').value;
      const expRatio = toNum($('expRatio').value)/100;
      const taxes = toNum($('taxes').value), ins = toNum($('ins').value), utils = toNum($('utils').value), repairs = toNum($('repairs').value), mgmtPct = toNum($('mgmtPct').value)/100, hoa = toNum($('hoa').value);

      const targetDSCR = toNum($('targetDSCR').value);
      const targetCoC = toNum($('targetCoC').value)/100;
      const targetLTV = toNum($('targetLTV').value)/100;

      const gRent = toNum($('gRent').value)/100;
      const gOther = toNum($('gOther').value)/100;
      const gOpex = toNum($('gOpex').value)/100;
      const exitCap = Math.max(0.0001, toNum($('exitCap').value)/100);

      const down = price*downPct;
      const closing = price*closePct;
      const loan = Math.max(0, price - down);

      const moDebtAmort = amortPayment(loan, rate, years);
      const moDebtIO = (rate>0) ? loan*(rate/100)/12 : 0;

      const sgi = rent*12 + otherInc*12;
      const egi = sgi * (1 - vacancy);

      let opexAnnual;
      if (expModeVal.startsWith('Ratio')) opexAnnual = egi*expRatio;
      else { const mgmt = egi*mgmtPct; opexAnnual = (taxes+ins+utils+repairs+hoa)*12 + mgmt; }

      const loanAnnualDebtY1 = (loanType==='Interest Only' && ioMonths>0)
        ? (moDebtIO*Math.min(12, ioMonths) + moDebtAmort*Math.max(0, 12- Math.min(12, ioMonths)))
        : (loanType==='Interest Only' ? moDebtIO*12 : moDebtAmort*12);

      const noi = egi - opexAnnual;
      const annCF = noi - loanAnnualDebtY1;

      const dscr = loanAnnualDebtY1>0 ? (noi/loanAnnualDebtY1) : null;
      const cap = price>0 ? (noi/price) : null;

      const upfront = down + closing + reno;
      const coc = upfront>0 ? (annCF/upfront) : null;

      const beOcc = Math.max(0, Math.min(1, (opexAnnual + loanAnnualDebtY1 - (otherInc*12)) / Math.max(1, rent*12)));
      const ltv = price>0 ? (loan/price) : null;
      const ltc = (price+reno+closing)>0 ? (loan/(price+reno+closing)) : null;
      const grm = (rent*12)>0 ? (price/(rent*12)) : null;
      const ppu = (units>0) ? (price/units) : null;
      const ppsf = (sqft>0) ? (price/sqft) : null;

      // KPIs (Year-1)
      $('kpiNOI').textContent = money(noi);
      $('kpiCF').textContent = money(annCF);
      $('kpiDSCR').textContent = dscr? dscr.toFixed(2) : '‚Äî';
      $('kpiCap').textContent = cap? (cap*100).toFixed(2)+'%' : '‚Äî';
      $('kpiCoC').textContent = coc? (coc*100).toFixed(2)+'%' : '‚Äî';

      // Results (Year-1)
      $('upfront').value = money(upfront);
      $('loanAmt').value = money(loan);
      $('moDebt').value = money(loanType==='Amortizing' ? moDebtAmort : moDebtIO);
      $('annDebt').value = money(loanAnnualDebtY1);
      $('egi').value = money(egi);
      $('opex').value = money(opexAnnual);
      $('noi').value = money(noi);
      $('annCF').value = money(annCF);
      $('dscr').value = dscr? dscr.toFixed(2) : '‚Äî';
      $('cap').value = cap? (cap*100).toFixed(2)+'%' : '‚Äî';
      $('coc').value = coc? (coc*100).toFixed(2)+'%' : '‚Äî';
      $('beOcc').value = (beOcc*100).toFixed(1)+'%';
      $('ltv').value = ltv!=null ? (ltv*100).toFixed(1)+'%' : '‚Äî';
      $('ltc').value = ltc!=null ? (ltc*100).toFixed(1)+'%' : '‚Äî';
      $('ppu').value = ppu!=null ? '$'+ppu.toLocaleString(undefined,{maximumFractionDigits:0}) : '‚Äî';
      $('ppsf').value = ppsf!=null ? '$'+ppsf.toLocaleString(undefined,{maximumFractionDigits:2}) : '‚Äî';
      $('grmDisplay').value = grm!=null ? grm.toFixed(2) : '‚Äî';

      const good = (noi/12 - (loanAnnualDebtY1/12)) >= 0;
      const dot = $('signalDot'); const txt = $('signalText');
      dot.className = 'dot ' + (good? 'good' : 'bad');
      txt.textContent = good ? 'Cash-flow positive' : 'Not cash-flowing';

      const dscrPass = !dscr || dscr >= targetDSCR;
      const cocPass = !coc || coc >= targetCoC;
      const ltvPass = !ltv || ltv <= targetLTV;
      const allPass = dscrPass && cocPass && ltvPass && good;
      $('flagDSCR').textContent = `DSCR ${dscr? dscr.toFixed(2):'‚Äî'} ‚Ä¢ CoC ${coc? (coc*100).toFixed(1)+'%':'‚Äî'} ‚Ä¢ LTV ${ltv? (ltv*100).toFixed(1)+'%':'‚Äî'}`;
      $('flagDSCR').style.color = allPass ? 'var(--good)' : (dscrPass && ltvPass ? 'var(--ink)' : 'var(--bad)');

      // Projection & Value-Add
      buildProjection({ gRent, gOther, gOpex, rentMo: rent, otherMo: otherInc, vacancy,
                        expModeVal, expRatio, taxes, ins, utils, repairs, mgmtPct, hoa,
                        loanType, moDebtAmort, moDebtIO, ioMonths, years, exitCap });
      runValueAdd({ gRent });

      saveInputs();
    }

    function buildProjection(ctx){
      const { gRent, gOther, gOpex, rentMo, otherMo, vacancy,
              expModeVal, expRatio, taxes, ins, utils, repairs, mgmtPct, hoa,
              loanType, moDebtAmort, moDebtIO, ioMonths, years, exitCap } = ctx;

      let ioLeft = (loanType==='Interest Only') ? Math.max(0, ioMonths|0) : 0;
      const tbody = $('projBody'); tbody.innerHTML = '';
      for (let y=1; y<=10; y++){
        const rentY = rentMo * Math.pow(1+gRent, y-1);
        const otherY = otherMo * Math.pow(1+gOther, y-1);
        const sgiY = (rentY + otherY) * 12;
        const egiY = sgiY * (1 - vacancy);

        let opexY;
        if (expModeVal.startsWith('Ratio')) opexY = egiY * expRatio;
        else {
          const fixedBase = (taxes+ins+utils+repairs+hoa)*12;
          const fixedY = fixedBase * Math.pow(1+gOpex, y-1);
          const mgmtY = egiY * mgmtPct;
          opexY = fixedY + mgmtY;
        }

        const noiY = egiY - opexY;

        let debtY;
        if (loanType==='Interest Only'){
          const ioThisYear = Math.min(12, Math.max(0, ioLeft));
          debtY = moDebtIO*ioThisYear + moDebtAmort*(12-ioThisYear);
          ioLeft = Math.max(0, ioLeft-12);
        } else {
          debtY = moDebtAmort*12;
        }

        const cfY = noiY - debtY;
        const dscrY = debtY>0 ? (noiY/debtY) : null;
        const valueY = exitCap>0 ? (noiY/exitCap) : 0;

        const tr = document.createElement('tr');
        [ y, money0(Math.round(egiY)), money0(Math.round(opexY)), money0(Math.round(noiY)),
          money0(Math.round(debtY)), money0(Math.round(cfY)), (dscrY? dscrY.toFixed(2):'‚Äî'), money0(Math.round(valueY)) ]
          .forEach((txt)=>{ const td=document.createElement('td'); td.textContent=txt; tr.appendChild(td); });
        tbody.appendChild(tr);
      }
    }

    function runValueAdd({ gRent }){
      const toNum = v => +v || 0;
      const units = toNum($('units').value);

      const vaYears = Math.min(10, Math.max(1, toNum($('vaYears').value) || 1));
      const vaUnits = toNum($('vaUnits').value) || units;
      const upliftRent = toNum($('vaRentUplift').value);
      const upliftOther = toNum($('vaOtherUplift').value);
      const vaOpexDelta = toNum($('vaOpexDelta').value);
      const vaCapex = toNum($('vaCapex').value);
      const vaCap = Math.max(0.0001, toNum($('vaCap').value)/100 || 0.07);
      const grow = $('vaGrow')?.checked ?? true;

      const upliftBaseMo = vaUnits * (upliftRent + upliftOther);
      const addedNOI_Mo_Y1 = Math.max(0, upliftBaseMo - vaOpexDelta);
      const addedNOI_Y1 = addedNOI_Mo_Y1 * 12;

      const growthFactor = grow ? Math.pow(1+gRent, vaYears-1) : 1;
      const addedNOI_Target = addedNOI_Y1 * growthFactor;

      const valueAdded = addedNOI_Target / vaCap;
      const paybackYears = addedNOI_Y1>0 ? (vaCapex / addedNOI_Y1) : Infinity;

      $('vaNOI1').value = money(Math.round(addedNOI_Y1));
      $('vaNOIN').value = money(Math.round(addedNOI_Target));
      $('vaValue').value = money(Math.round(valueAdded));
      $('vaPayback').value = isFinite(paybackYears) ? paybackYears.toFixed(1) : '‚Äî';
    }

    function applyHints(){
      const type = $('propType').value, lease = $('leaseType').value;
      if (lease==='NNN'){
        if ($('expMode').value.startsWith('Ratio')) $('expRatio').value = 20;
        $('mgmtPct').value = 5; $('utils').value = 0;
      } else if (lease==='Modified Gross'){
        if ($('expMode').value.startsWith('Ratio')) $('expRatio').value = (type==='Retail'||type==='Office')? 28 : 35;
        $('mgmtPct').value = 7;
      } else {
        if ($('expMode').value.startsWith('Ratio')) $('expRatio').value = (type==='Single-family')? 25 : 40;
        $('mgmtPct').value = 8;
      }
      if (type==='Single-family') $('vacancy').value = 4;
      if (type==='Multifamily') $('vacancy').value = 6;
      if (type==='Retail'||type==='Office') $('vacancy').value = 8;
      if (type==='Industrial') $('vacancy').value = 7;
    }
    $('propType').addEventListener('change', applyHints);
    $('leaseType').addEventListener('change', applyHints);

    /* ===== Ninja & Pirate ===== */
    $('ninjaBtn').addEventListener('click', () => {
      const n = document.createElement('div'); n.className = 'ninja run'; n.textContent = 'ü•∑';
      document.body.appendChild(n); n.addEventListener('animationend', () => n.remove());
    });
    $('pirateBtn').addEventListener('click', () => {
      const p = document.createElement('div'); p.className = 'pirate run'; p.textContent = '‚ò†Ô∏è';
      document.body.appendChild(p); p.addEventListener('animationend', () => p.remove());
    });

    /* ===== Export CSV ===== */
    function csvEscape(v){
      const s = String(v ?? '');
      return (s.includes(',') || s.includes('"') || s.includes('\n')) ? `"${s.replace(/"/g,'""')}"` : s;
    }
    function rowsToCSV(rows){ return rows.map(r=>r.map(csvEscape).join(',')).join('\n'); }
    function exportCSV(){
      analyze();
      const now = new Date(), pad = n => String(n).padStart(2,'0');
      const stamp = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;
      const fname = `kapi_deal_export_${stamp}.csv`;

      const getVal = id => (document.getElementById(id)?.value ?? '');
      const rows = [
        ['Kapi Deal Calculator Export', now.toISOString()],
        [],
        ['Section','Field','Value'],
        ['Basics','Property type', getVal('propType')],
        ['Basics','Lease type', getVal('leaseType')],
        ['Basics','Units', getVal('units')],
        ['Basics','Square Footage', getVal('sqft')],
        ['Basics','Purchase price', getVal('price')],
        ['Basics','Down payment %', getVal('downPct')],
        ['Basics','Closing costs %', getVal('closePct')],
        ['Basics','Upfront CapEx', getVal('reno')],
        ['Income','Monthly rent', getVal('rent')],
        ['Income','Other income / mo', getVal('otherInc')],
        ['Income','Vacancy %', getVal('vacancy')],
        ['Expenses','Mode', getVal('expMode')],
        ['Expenses','Expense ratio %', getVal('expRatio')],
        ['Expenses','Taxes/mo', getVal('taxes')],
        ['Expenses','Insurance/mo', getVal('ins')],
        ['Expenses','Utilities/mo', getVal('utils')],
        ['Expenses','Repairs/mo', getVal('repairs')],
        ['Expenses','Mgmt % of EGI', getVal('mgmtPct')],
        ['Expenses','HOA/mo', getVal('hoa')],
        ['Financing','Loan type', getVal('loanType')],
        ['Financing','Rate %', getVal('rate')],
        ['Financing','Term years', getVal('termYears')],
        ['Financing','IO months', getVal('ioMonths')],
        ['Projections','Rent growth %/yr', getVal('gRent')],
        ['Projections','Other growth %/yr', getVal('gOther')],
        ['Projections','Opex growth %/yr', getVal('gOpex')],
        ['Projections','Exit cap %', getVal('exitCap')],
        ['Targets','Min DSCR', getVal('targetDSCR')],
        ['Targets','Min CoC %', getVal('targetCoC')],
        ['Targets','Max LTV %', getVal('targetLTV')],
        [],
        ['Section','Field','Value'],
        ['Year-1','Upfront cash', getVal('upfront')],
        ['Year-1','Loan amount', getVal('loanAmt')],
        ['Year-1','Monthly debt', getVal('moDebt')],
        ['Year-1','Annual debt', getVal('annDebt')],
        ['Year-1','EGI', getVal('egi')],
        ['Year-1','Opex', getVal('opex')],
        ['Year-1','NOI', getVal('noi')],
        ['Year-1','Cash flow', getVal('annCF')],
        ['Year-1','DSCR', getVal('dscr')],
        ['Year-1','Cap rate', getVal('cap')],
        ['Year-1','Cash-on-Cash', getVal('coc')],
        ['Year-1','Break-even occ', getVal('beOcc')],
        ['Year-1','LTV', getVal('ltv')],
        ['Year-1','LTC', getVal('ltc')],
        ['Year-1','Price/Unit', getVal('ppu')],
        ['Year-1','Price/SF', getVal('ppsf')],
        [],
        ['10-Year Projection'],
        ['Year','EGI','Opex','NOI','Debt','CF','DSCR','Value @ Exit Cap']
      ];

      document.querySelectorAll('#projBody tr').forEach(tr=>{
        rows.push(Array.from(tr.children).map(td=>td.textContent));
      });

      const csv = rowsToCSV(rows);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = fname; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    /* ===== Init ===== */
    function init(){
      loadTheme();

      const savedKey = localStorage.getItem('kapi.accentKey');
      if (savedKey === 'white'){ setAccentForTheme('graphite-smart'); paintSwatches(); }

      const last = localStorage.getItem('kapi.prestige.inputs');
      if (last) loadInputs();

      $('vaUnits').value = $('units').value || 0;

      applyHints();
      analyze();

      const ids = ['price','rent','otherInc','expRatio','downPct','closePct','reno','rate','termYears','ioMonths','vacancy','taxes','ins','utils','repairs','mgmtPct','hoa','units','sqft','targetDSCR','targetCoC','targetLTV','propType','leaseType','loanType','gRent','gOther','gOpex','exitCap','vaYears','vaUnits','vaRentUplift','vaOtherUplift','vaOpexDelta','vaCapex','vaCap','vaGrow'];
      document.querySelectorAll('input,select').forEach(el=>{
        el.addEventListener('change', e=>{ if (ids.includes(e.target.id)) analyze(); });
      });

      $('btnExport').addEventListener('click', exportCSV);
    }

    init();
  </script>

<!-- 1) Auth0 SPA SDK -->
<script src="https://cdn.auth0.com/js/auth0-spa-js/2.5/auth0-spa-js.production.js"></script>

<!-- 2) Your config (the file you just created at the root) -->
<script src="/auth0-config.js"></script>

<!-- 3) Client bootstrap (kapiAuth + kapiRequireAuth) -->
<script src="/auth0-client.js"></script>

</body>
</html>
