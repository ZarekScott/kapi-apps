<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kapi — Sign in</title>
  <link rel="stylesheet" href="assets/css/brand.css">
<script>
  window.netlifyIdentitySettings = {
    APIUrl: 'https://kapi-apps.netlify.app/.netlify/identity'
  };
</script>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    /* Fallback styling if brand.css is missing */
    :root{--bg:#0b1220;--panel:#0f172a;--border:#1f2a44;--text:#e5e7eb;--accent:#16a34a}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .kapi-card{max-width:520px;margin:56px auto;padding:24px;border-radius:16px;background:var(--panel);border:1px solid var(--border)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:transparent;color:#fff}
    .btn.primary{background:var(--accent);border-color:transparent}
    .muted{color:#94a3b8}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .mt-2{margin-top:8px}.mt-3{margin-top:12px}.mt-4{margin-top:16px}
    a{color:#fff;text-decoration:none}
  </style>
</head>
<body>
  <main class="kapi-card">
    <h1 style="margin:0 0 6px 0">Sign in to <strong>Kapi</strong></h1>
    <p class="muted" style="margin-top:0">Use your email to receive a magic link. Once signed in, you’ll be redirected to your Apps.</p>

    <div class="row mt-3">
      <button id="loginBtn" class="btn primary">Sign in</button>
      <button id="logoutBtn" class="btn">Sign out</button>
      <a class="btn" href="/apps.html" id="appsBtn">Go to Apps</a>
    </div>

    <div id="me" class="muted mt-3">Not signed in.</div>

    <div class="mt-4 muted" style="font-size:12px">
      Problems signing in? Make sure emails from Netlify aren’t blocked, or try a different browser.
    </div>
  </main>

  <script>
    function setText(el, txt){ if(el) el.textContent = txt; }
    function updateUI(user){
      const me = document.getElementById('me');
      const appsBtn = document.getElementById('appsBtn');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      if(user){
        setText(me, `Signed in as ${user.email}`);
        appsBtn.style.display = 'inline-flex';
        logoutBtn.style.display = 'inline-flex';
        loginBtn.style.display = 'none';
      }else{
        setText(me, 'Not signed in.');
        appsBtn.style.display = 'inline-flex';
        logoutBtn.style.display = 'none';
        loginBtn.style.display = 'inline-flex';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');

      loginBtn.addEventListener('click', () => netlifyIdentity.open('login'));
      logoutBtn.addEventListener('click', () => netlifyIdentity.logout());

      netlifyIdentity.on('init', user => updateUI(user));
      netlifyIdentity.on('login', user => {
        updateUI(user);
        // Redirect to apps after successful login
        window.location.href = '/apps.html';
      });
      netlifyIdentity.on('logout', () => updateUI(null));
      netlifyIdentity.init();
    });
  </script>
<script>
  // Auto-handle email confirmations like: https://kapi-apps.netlify.app/#confirmation_token=...
  (function () {
    const hash = (window.location.hash || '').replace(/^#/, '');
    const params = new URLSearchParams(hash);
    const token = params.get('confirmation_token');
    if (!token) return;

    // Use GoTrue if you included it; otherwise the Identity widget will also pick it up.
    // If you’re using GoTrue:
    //   const auth = new window.GoTrue({ APIUrl: 'https://kapi-apps.netlify.app/.netlify/identity' });
    if (window.GoTrue) {
      const auth = new window.GoTrue({ APIUrl: 'https://kapi-apps.netlify.app/.netlify/identity' });
      auth.confirm(token)
        .then(() => { window.location.replace('/apps.html'); })
        .catch(err => { console.error(err); alert('Verification failed: ' + (err && err.message || '')); });
    } else {
      // If you’re using only the Identity widget, just redirect — the widget will consume the token on init
      window.location.replace('/apps.html');
    }
  })();
</script>

<script src="https://cdn.auth0.com/js/auth0-spa-js/2.5/auth0-spa-js.production.js"></script>

<script src="/auth0-config.js"></script>

<script src="/auth0-client.js"></script>


</body>
</html>
