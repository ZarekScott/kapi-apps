<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kapi — Confirming…</title>
  <link rel="stylesheet" href="assets/css/brand.css">
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--border:#1f2a44;--text:#e5e7eb;--muted:#94a3b8;--accent:#16a34a}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:24px}
    .card{max-width:560px;width:100%;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:24px}
    .muted{color:var(--muted)}
    .ok{color:#bbf7d0}
    .err{color:#fecaca}
    a{color:#7dd3fc;text-decoration:none}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/gotrue-js/dist/gotrue.min.js"></script>
  <script>
    // Use your live Identity endpoint explicitly
    const auth = new window.GoTrue({ APIUrl: 'https://kapi-apps.netlify.app/.netlify/identity' });

    async function run(){
      const box = document.getElementById('box');
      const hash = (window.location.hash || '').replace(/^#/, '');
      const p = new URLSearchParams(hash);
      const confirm = p.get('confirmation_token');
      const recovery = p.get('recovery_token') || (p.get('type') === 'recovery' && p.get('access_token'));

      try {
        if (confirm) {
          box.innerHTML = '<p class="muted">Confirming your email…</p>';
          await auth.confirm(confirm);
          box.innerHTML = '<h1 class="ok">Email confirmed</h1><p class="muted">Redirecting to your apps…</p>';
          setTimeout(()=>window.location.replace('/apps.html'), 800);
          return;
        }
        if (recovery) {
          box.innerHTML = '<h1>Password recovery</h1><p class="muted">Token received. Redirecting to reset…</p>';
          setTimeout(()=>window.location.replace('/reset.html#recovery_token=' + encodeURIComponent(recovery)), 300);
          return;
        }
        box.innerHTML = '<h1 class="err">Missing token</h1><p class="muted">This page expects a confirmation or recovery token in the URL.</p><p><a href="/login.html">Go to login</a></p>';
      } catch (e) {
        box.innerHTML = '<h1 class="err">Verification failed</h1><p class="muted">' + (e && e.message ? e.message : 'Unknown error') + '</p><p><a href="/login.html">Back to login</a></p>';
      }
    }
    document.addEventListener('DOMContentLoaded', run);
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card" id="box">
      <h1>Verifying…</h1>
      <p class="muted">Please wait.</p>
    </div>
  </div>

<script src="https://cdn.auth0.com/js/auth0-spa-js/2.5/auth0-spa-js.production.js"></script>

<script src="/auth0-config.js"></script>

<script src="/auth0-client.js"></script>

</body>
</html>
